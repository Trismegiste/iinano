{% extends 'TrismegisteSocialBundle:Content:publishing_form.html.twig' %}

{% block crud %}
    {% if form.vars.value is null %}
        {{ render(controller('TrismegisteSocialBundle:Picture:renderForm')) }}
        <img id="upload-preview"/>
    {% else %}
        <img src="{{ path('picture_get', {storageKey: form.vars.value.storageKey}) }}"/>
        {{ parent() }}
    {% endif %}
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script type="text/javascript">

        // can also be from a drag-from-desktop drop
        //  $('dropZone')[0].ondrop = function(e) {
        //      e.preventDefault();
        //      sendFile(e.dataTransfer.files[0]);
        //  };

        // preview
        $('form[data-autouploader] input[type=file]').on('change', function (event) {
            var input = event.target;

            if (input.files && input.files[0]) {
                var selectFile = input.files[0]

                // preview :
                var reader = new FileReader();
                reader.onload = function (event) {
                    $('#upload-preview').attr('src', event.target.result)
                }
                reader.readAsDataURL(selectFile)

                // preparing autosubmit :
                var formParam = new FormData()
                $('form[data-autouploader] input[type=hidden]').each(function (idx, field) {
                    formParam.append($(field).attr('name'), $(field).attr('value'))
                })
                formParam.append($('form[data-autouploader] input[type=file]').attr('name'), selectFile)

                // post the form through ajax
                $.ajax({
                    type: 'post',
                    url: '{{ path('picture_upload') }}',
                    data: formParam,
                    xhrFields: {
                        // add listener to XMLHTTPRequest object directly for progress (jquery doesn't have this yet)
                        onprogress: function (progress) {
                            // calculate upload progress
                            var percentage = Math.floor((progress.total / progress.totalSize) * 100);
                            // log upload progress to console
                            console.log('progress', percentage);
                            if (percentage === 100) {
                                console.log('DONE!');
                            }
                        }
                    },
                    processData: false,
                    contentType: false
                }).done(function (response) {
                    window.location.replace('/app_dev.php/pub/' + response.id + '/edit');
                }).fail(function (response) {
                    alert('Your browser does not support this feature');
                })
            }
        })

    </script>
{% endblock %}
