{% extends 'TrismegisteSocialBundle:Content:publishing_form.html.twig' %}

{% block crud %}
    {{ render(controller('TrismegisteSocialBundle:Picture:renderForm')) }}
    <img id="upload-preview"/>
    {# parent() en fait c'est ou l'un ou l'autre #}
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script type="text/javascript">

        // can also be from a drag-from-desktop drop
        //  $('dropZone')[0].ondrop = function(e) {
        //      e.preventDefault();
        //      sendFile(e.dataTransfer.files[0]);
        //  };

        // preview
        $('form[data-autouploader] input[type=file]').on('change', function (event) {
            var input = event.target;

            if (input.files && input.files[0]) {
                var selectFile = input.files[0]
                console.log(selectFile)
                var reader = new FileReader();

                reader.onload = function (event) {
                    $('#upload-preview').attr('src', event.target.result)
                }
                reader.readAsDataURL(selectFile)

                sendFile(selectFile);
            }
        })


        function sendFile(file) {

            var formParam = new FormData()
            $('form[data-autouploader] input[type=hidden]').each(function (idx, field) {
                formParam.append($(field).attr('name'), $(field).attr('value'))
            })
            formParam.append($('form[data-autouploader] input[type=file]').attr('name'), file)


            $.ajax({
                type: 'post',
                url: '{{ path('picture_upload') }}',
                data: formParam,
                success: function () {
                    console.log('ok')
                },
                xhrFields: {
                    // add listener to XMLHTTPRequest object directly for progress (jquery doesn't have this yet)
                    onprogress: function (progress) {
                        // calculate upload progress
                        var percentage = Math.floor((progress.total / progress.totalSize) * 100);
                        // log upload progress to console
                        console.log('progress', percentage);
                        if (percentage === 100) {
                            console.log('DONE!');
                        }
                    }
                },
                processData: false,
                contentType: false
            });
        }


    </script>
{% endblock %}
